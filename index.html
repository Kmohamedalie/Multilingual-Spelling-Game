<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Spelling Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        .custom-btn {
            @apply px-6 py-3 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-75;
        }
        .custom-btn-primary {
            @apply bg-sky-600 text-white hover:bg-sky-700 focus:ring-sky-500;
        }
        .custom-btn-secondary {
            @apply bg-slate-200 text-slate-700 hover:bg-slate-300 focus:ring-slate-400;
        }
        .custom-btn-green {
            @apply bg-green-500 text-white hover:bg-green-600 focus:ring-green-400;
        }
        .custom-btn-red {
            @apply bg-red-500 text-white hover:bg-red-600 focus:ring-red-400;
        }
        .custom-input {
            @apply w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow;
        }
        .feedback-correct {
            @apply text-green-600 font-semibold;
        }
        .feedback-incorrect {
            @apply text-red-600 font-semibold;
        }
        /* Modal styles */
        .modal {
            @apply fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4;
        }
        #userIdDisplay {
            @apply fixed top-2 right-2 bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-md shadow;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="userIdDisplay" class="hidden">User ID: <span id="userIdValue"></span></div>

    <div id="loadingIndicator" class="text-center p-10 w-full">
        <svg class="animate-spin h-10 w-10 text-sky-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-medium text-slate-700">Loading Game...</p>
    </div>

    <div id="appContainer" class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-xl shadow-xl hidden">

        <div id="languageSelectionScreen">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-sky-700 mb-8">Multilingual Spelling Game</h1>
            <div class="mb-6">
                <label for="languageSelect" class="block text-lg font-medium text-slate-700 mb-2">Choose your language:</label>
                <select id="languageSelect" class="custom-input text-lg">
                    <option value="">-- Select Language --</option>
                </select>
            </div>
            <button id="playGameBtn" class="custom-btn custom-btn-primary w-full text-lg" disabled>Play Game</button>
        </div>

        <div id="gameScreen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="currentLanguageDisplay" class="text-2xl font-semibold text-sky-700"></h2>
                <button id="changeLangBtn" class="custom-btn custom-btn-secondary text-sm py-2 px-4">Change Language</button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                <div class="bg-sky-100 p-4 rounded-lg shadow">
                    <p class="text-sm text-sky-600 font-medium">Current Score</p>
                    <p id="currentScoreDisplay" class="text-2xl font-bold text-sky-800">0 / 0</p>
                </div>
                <div class="bg-amber-100 p-4 rounded-lg shadow">
                    <p class="text-sm text-amber-600 font-medium">Best Score</p>
                    <p id="bestScoreDisplay" class="text-2xl font-bold text-amber-800">0</p>
                </div>
            </div>

            <div class="mb-6 text-center">
                <button id="speakWordBtn" class="custom-btn custom-btn-green w-full sm:w-auto mb-2 sm:mb-0 sm:mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.536 8.464a5 5 0 000 7.072m2.829-9.9a9 9 0 000 12.728m0 0l-.001.001M12 18.59l-.01-.011M12 5.411l.01.01" />
                    </svg>
                    Speak Word
                </button>
                 <button id="repeatWordBtn" class="custom-btn custom-btn-secondary w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                    </svg>
                    Repeat
                </button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="spellInput" class="custom-input text-xl text-center" placeholder="Type the spelling here...">
            </div>
            <button id="submitAnswerBtn" class="custom-btn custom-btn-primary w-full text-lg mb-4">Submit Answer</button>
            
            <div id="feedbackArea" class="text-center text-lg min-h-[2.5em] mb-4"></div>
            
            <button id="nextWordBtn" class="custom-btn custom-btn-secondary w-full text-lg hidden">Next Word</button>
        </div>

        <div id="gameOverModal" class="modal hidden">
            <div class="modal-content text-center">
                <h2 id="gameOverTitle" class="text-3xl font-bold text-sky-700 mb-4">Game Over!</h2>
                <p id="finalScoreDisplay" class="text-xl mb-2">Your final score: <span class="font-bold"></span></p>
                <p id="gameOverBestScoreInfo" class="text-lg mb-6"></p>
                <div class="space-y-3 sm:space-y-0 sm:space-x-3">
                    <button id="playAgainBtn" class="custom-btn custom-btn-primary w-full sm:w-auto">Play Again (Same Language)</button>
                    <button id="modalChangeLangBtn" class="custom-btn custom-btn-secondary w-full sm:w-auto">Change Language</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const appContainer = document.getElementById('appContainer');
        const languageSelect = document.getElementById('languageSelect');
        const playGameBtn = document.getElementById('playGameBtn');
        const languageSelectionScreen = document.getElementById('languageSelectionScreen');
        const gameScreen = document.getElementById('gameScreen');
        const currentLanguageDisplay = document.getElementById('currentLanguageDisplay');
        const currentScoreDisplay = document.getElementById('currentScoreDisplay');
        const bestScoreDisplay = document.getElementById('bestScoreDisplay');
        const speakWordBtn = document.getElementById('speakWordBtn');
        const repeatWordBtn = document.getElementById('repeatWordBtn');
        const spellInput = document.getElementById('spellInput');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const feedbackArea = document.getElementById('feedbackArea');
        const nextWordBtn = document.getElementById('nextWordBtn');
        const changeLangBtn = document.getElementById('changeLangBtn');
        
        const gameOverModal = document.getElementById('gameOverModal');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const finalScoreDisplay = document.getElementById('finalScoreDisplay').querySelector('span');
        const gameOverBestScoreInfo = document.getElementById('gameOverBestScoreInfo');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const modalChangeLangBtn = document.getElementById('modalChangeLangBtn');

        const userIdDisplay = document.getElementById('userIdDisplay');
        const userIdValue = document.getElementById('userIdValue');

        // Game Configuration
        const WORDS_PER_GAME = 15; 
        const wordsData = {
            en: { name: "English", langCode: "en-US", list: ["apple", "banana", "computer", "elephant", "guitar", "language", "mountain", "ocean", "programming", "sunshine", "beautiful", "adventure", "knowledge", "restaurant", "calendar", "technology", "environment", "communication", "opportunity", "experience", "vocabulary", "dictionary", "umbrella", "vacation", "celebration"] },
            es: { name: "EspaÃ±ol", langCode: "es-ES", list: ["manzana", "plÃ¡tano", "computadora", "elefante", "guitarra", "idioma", "montaÃ±a", "ocÃ©ano", "programaciÃ³n", "sol", "hermoso", "aventura", "conocimiento", "restaurante", "calendario", "tecnologÃ­a", "ambiente", "comunicaciÃ³n", "oportunidad", "experiencia", "vocabulario", "diccionario", "paraguas", "vacaciones", "celebraciÃ³n"] },
            fr: { name: "FranÃ§ais", langCode: "fr-FR", list: ["pomme", "banane", "ordinateur", "Ã©lÃ©phant", "guitare", "langue", "montagne", "ocÃ©an", "programmation", "soleil", "magnifique", "aventure", "connaissance", "restaurant", "calendrier", "technologie", "environnement", "communication", "opportunitÃ©", "expÃ©rience", "vocabulaire", "dictionnaire", "parapluie", "vacances", "cÃ©lÃ©bration"] },
            de: { name: "Deutsch", langCode: "de-DE", list: ["Apfel", "Banane", "Computer", "Elefant", "Gitarre", "Sprache", "Berg", "Ozean", "Programmierung", "Sonnenschein", "wunderschÃ¶n", "Abenteuer", "Wissen", "Restaurant", "Kalender", "Technologie", "Umwelt", "Kommunikation", "Gelegenheit", "Erfahrung", "Wortschatz", "WÃ¶rterbuch", "Regenschirm", "Urlaub", "Feier"] },
            it: { name: "Italiano", langCode: "it-IT", list: ["mela", "banana", "computer", "elefante", "chitarra", "lingua", "montagna", "oceano", "programmazione", "sole", "bellissimo", "avventura", "conoscenza", "ristorante", "calendario", "tecnologia", "ambiente", "comunicazione", "opportunitÃ ", "esperienza", "vocabolario", "dizionario", "ombrello", "vacanza", "celebrazione"] }
        };

        // Game State
        let currentLanguageKey = '';
        let gameWords = [];
        let currentWordIndex = 0;
        let currentScore = 0;
        let currentBestScore = 0;
        let currentWordToSpell = '';
        let synth = window.speechSynthesis;
        let voices = [];

        // Firebase State
        let db, auth, userId, app;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-spelling-game';

        function alertUser(message) {
            console.warn("ALERT USER:", message);
            let alertBox = document.getElementById('customAlertBox');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'customAlertBox';
                alertBox.className = "fixed top-3 left-1/2 -translate-x-1/2 bg-red-600 bg-opacity-90 text-white px-5 py-3 rounded-lg shadow-lg text-sm z-[1001] transition-opacity duration-500 ease-out opacity-0";
                document.body.appendChild(alertBox);
            }
            alertBox.textContent = message;
            
            requestAnimationFrame(() => {
                alertBox.classList.remove('opacity-0');
                alertBox.classList.add('opacity-100');
            });

            if (alertBox.hideTimeout) clearTimeout(alertBox.hideTimeout);
            if (alertBox.removeTimeout) clearTimeout(alertBox.removeTimeout);

            alertBox.hideTimeout = setTimeout(() => {
                alertBox.classList.remove('opacity-100');
                alertBox.classList.add('opacity-0');
                alertBox.removeTimeout = setTimeout(() => {
                    if (alertBox.parentNode) {
                        alertBox.parentNode.removeChild(alertBox);
                    }
                }, 500); 
            }, 5000);
        }


        async function initFirebase() {
            try {
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!firebaseConfigStr) {
                    console.error("Firebase config not found.");
                    alertUser("Critical Error: Firebase configuration is missing. The game cannot save scores.");
                    loadingIndicator.innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-md shadow-md w-full max-w-lg mx-auto">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-10 w-10 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </div>
                                <div class="text-left">
                                    <p class="font-bold text-xl mb-1">Critical Application Error</p>
                                    <p class="text-md">The game cannot start correctly because essential configuration (Firebase) is missing.</p>
                                    <p class="text-sm mt-2 text-slate-600">Scores and progress cannot be saved. If you are seeing this on a platform, please report it. If running locally, ensure Firebase is configured.</p>
                                </div>
                            </div>
                        </div>`;
                    return false;
                }
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                await setPersistence(auth, browserLocalPersistence); 

                return new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                userId = auth.currentUser?.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser?.uid;
                            }
                        }
                        if (!userId) userId = crypto.randomUUID(); 

                        userIdValue.textContent = userId;
                        userIdDisplay.classList.remove('hidden');
                        console.log("User ID:", userId);
                        resolve(true);
                    });
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                alertUser(`Firebase Error: ${error.message}. Scores might not be saved.`);
                loadingIndicator.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-md shadow-md w-full max-w-lg mx-auto">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-10 w-10 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-xl mb-1">Firebase Initialization Error</p>
                                <p class="text-md">${error.message}</p>
                                <p class="text-sm mt-2 text-slate-600">Scores and progress might not be saved correctly.</p>
                            </div>
                        </div>
                    </div>`;
                return false;
            }
        }
        
        function populateLanguageSelect() {
            Object.keys(wordsData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = wordsData[key].name;
                languageSelect.appendChild(option);
            });
        }

        function loadVoices() {
            voices = synth.getVoices();
            if (voices.length === 0 && 'onvoiceschanged' in synth) {
                synth.onvoiceschanged = () => {
                    voices = synth.getVoices();
                };
            }
        }

        function speakWord(word, langCode) {
            if (!synth) {
                alertUser("Sorry, your browser doesn't support speech synthesis.");
                return;
            }
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(word);
            let voice = voices.find(v => v.lang === langCode);
            if (!voice) voice = voices.find(v => v.lang.startsWith(langCode.split('-')[0]));
            if (!voice && voices.length > 0) {
                const baseLang = langCode.split('-')[0];
                voice = voices.find(v => v.lang.startsWith(baseLang) && v.default);
                if (!voice) voice = voices.find(v => v.lang.startsWith(baseLang));
            }

            if (voice) utterance.voice = voice;
            utterance.lang = langCode; 
            utterance.pitch = 1;
            utterance.rate = 0.9;
            
            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                alertUser(`Could not speak the word. Error: ${event.error}. Please try again or check your browser's speech settings.`);
                 feedbackArea.textContent = `Error speaking word. Try typing: ${word}`; 
                 feedbackArea.className = 'feedback-incorrect';
            };
            synth.speak(utterance);
        }

        async function loadBestScore() {
            if (!db || !userId || !currentLanguageKey) {
                bestScoreDisplay.textContent = 'N/A';
                return;
            }
            const scoreRef = doc(db, `artifacts/${appId}/users/${userId}/spellingGameScores/${currentLanguageKey}`);
            try {
                const docSnap = await getDoc(scoreRef);
                if (docSnap.exists()) {
                    currentBestScore = docSnap.data().bestScore || 0;
                } else {
                    currentBestScore = 0;
                }
            } catch (error) {
                console.error("Error loading best score:", error);
                currentBestScore = 0; 
                alertUser("Could not load your best score for this language.");
            }
            bestScoreDisplay.textContent = currentBestScore;
        }

        async function saveScore() {
            if (!db || !userId || !currentLanguageKey) {
                 alertUser("Cannot save score: Firebase not ready or user not identified.");
                return;
            }
            
            let newBest = false;
            if (currentScore > currentBestScore) {
                currentBestScore = currentScore;
                newBest = true;
            }

            const scoreRef = doc(db, `artifacts/${appId}/users/${userId}/spellingGameScores/${currentLanguageKey}`);
            try {
                const docSnap = await getDoc(scoreRef);
                if (docSnap.exists()) {
                    if (currentScore > (docSnap.data().bestScore || 0) ) { 
                         await updateDoc(scoreRef, { bestScore: currentScore, lastPlayed: serverTimestamp() });
                         console.log("Best score updated in Firestore.");
                    } else if (!docSnap.data().lastPlayed) { 
                        await updateDoc(scoreRef, { lastPlayed: serverTimestamp() });
                    }
                } else {
                     await setDoc(scoreRef, { 
                        bestScore: currentScore, 
                        language: wordsData[currentLanguageKey].name, 
                        langKey: currentLanguageKey, 
                        lastPlayed: serverTimestamp() 
                    });
                     console.log("New score record created in Firestore.");
                }
                return newBest; 
            } catch (error) {
                console.error("Error saving score:", error);
                alertUser(`Error saving score: ${error.message}. Your score might not have been saved.`);
                return false;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            currentScore = 0;
            currentWordIndex = 0;
            const allWordsForLanguage = wordsData[currentLanguageKey].list;
            const wordsToPlayCount = Math.min(WORDS_PER_GAME, allWordsForLanguage.length);
            if (allWordsForLanguage.length < WORDS_PER_GAME) {
                console.warn(`Not enough words for ${wordsData[currentLanguageKey].name}. Using all available words.`);
            }
            gameWords = shuffleArray([...allWordsForLanguage]).slice(0, wordsToPlayCount); 
            
            if (gameWords.length === 0) {
                alertUser("No words available for this language. Please select another language or add more words.");
                showLanguageSelectionScreen();
                return;
            }

            currentLanguageDisplay.textContent = wordsData[currentLanguageKey].name;
            languageSelectionScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameOverModal.classList.add('hidden');
            
            loadBestScore().then(() => {
                 displayNextWord();
            });
        }

        function displayNextWord() {
            if (currentWordIndex >= gameWords.length) {
                endGame();
                return;
            }
            currentWordToSpell = gameWords[currentWordIndex];
            currentScoreDisplay.textContent = `${currentScore} / ${gameWords.length}`;
            spellInput.value = '';
            spellInput.disabled = false;
            spellInput.focus();
            feedbackArea.textContent = '';
            feedbackArea.className = '';
            submitAnswerBtn.disabled = false;
            submitAnswerBtn.classList.remove('custom-btn-secondary', 'opacity-50', 'cursor-not-allowed');
            submitAnswerBtn.classList.add('custom-btn-primary');
            nextWordBtn.classList.add('hidden');
            speakWordBtn.disabled = false;
            repeatWordBtn.disabled = false;
            setTimeout(() => {
                speakWord(currentWordToSpell, wordsData[currentLanguageKey].langCode);
            }, 100);
        }

        function checkAnswer() {
            const userAnswer = spellInput.value.trim().toLowerCase();
            const correctAnswer = currentWordToSpell.toLowerCase();

            submitAnswerBtn.disabled = true;
            submitAnswerBtn.classList.add('custom-btn-secondary', 'opacity-50', 'cursor-not-allowed');
            submitAnswerBtn.classList.remove('custom-btn-primary');
            speakWordBtn.disabled = true; 
            repeatWordBtn.disabled = true;
            spellInput.disabled = true;

            if (userAnswer === correctAnswer) {
                currentScore++;
                feedbackArea.textContent = "Correct!";
                feedbackArea.className = 'feedback-correct';
            } else {
                feedbackArea.textContent = `Incorrect. The word was: ${currentWordToSpell}`;
                feedbackArea.className = 'feedback-incorrect';
            }
            currentScoreDisplay.textContent = `${currentScore} / ${gameWords.length}`;
            
            currentWordIndex++;
            if (currentWordIndex < gameWords.length) {
                nextWordBtn.classList.remove('hidden');
                nextWordBtn.focus();
            } else {
                setTimeout(endGame, 1000); 
            }
        }

        async function endGame() {
            spellInput.disabled = true;
            submitAnswerBtn.disabled = true;
            nextWordBtn.classList.add('hidden');
            speakWordBtn.disabled = true;
            repeatWordBtn.disabled = true;

            finalScoreDisplay.textContent = `${currentScore} / ${gameWords.length}`;
            const newBest = await saveScore(); 

            if (newBest) {
                gameOverBestScoreInfo.textContent = `ðŸŽ‰ New Best Score for ${wordsData[currentLanguageKey].name}!`;
                gameOverBestScoreInfo.className = 'text-green-600 font-semibold text-xl';
                gameOverTitle.textContent = "Excellent!";
            } else {
                gameOverBestScoreInfo.textContent = `Your best score for ${wordsData[currentLanguageKey].name} is ${currentBestScore}. Keep practicing!`;
                gameOverBestScoreInfo.className = 'text-slate-600';
                gameOverTitle.textContent = "Game Over!";
            }
            gameOverModal.classList.remove('hidden');
        }
        
        function showLanguageSelectionScreen() {
            gameScreen.classList.add('hidden');
            gameOverModal.classList.add('hidden');
            languageSelectionScreen.classList.remove('hidden');
            playGameBtn.disabled = true;
            playGameBtn.classList.add('custom-btn-secondary', 'opacity-50', 'cursor-not-allowed');
            playGameBtn.classList.remove('custom-btn-primary');
            languageSelect.value = "";
            currentLanguageKey = "";
        }

        // Event Listeners
        languageSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                currentLanguageKey = e.target.value;
                playGameBtn.disabled = false;
                playGameBtn.classList.remove('custom-btn-secondary', 'opacity-50', 'cursor-not-allowed');
                playGameBtn.classList.add('custom-btn-primary');
            } else {
                playGameBtn.disabled = true;
                playGameBtn.classList.add('custom-btn-secondary', 'opacity-50', 'cursor-not-allowed');
                playGameBtn.classList.remove('custom-btn-primary');
            }
        });

        playGameBtn.addEventListener('click', () => {
            if (currentLanguageKey) {
                if (voices.length === 0) {
                    loadVoices(); 
                    setTimeout(() => startGame(), 250); 
                } else {
                    startGame();
                }
            }
        });
        
        speakWordBtn.addEventListener('click', () => {
            if (currentWordToSpell) {
                speakWord(currentWordToSpell, wordsData[currentLanguageKey].langCode);
            }
        });
        repeatWordBtn.addEventListener('click', () => {
             if (currentWordToSpell) {
                speakWord(currentWordToSpell, wordsData[currentLanguageKey].langCode);
            }
        });

        submitAnswerBtn.addEventListener('click', checkAnswer);
        spellInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !submitAnswerBtn.disabled) {
                checkAnswer();
            }
        });

        nextWordBtn.addEventListener('click', displayNextWord);
        changeLangBtn.addEventListener('click', showLanguageSelectionScreen);
        modalChangeLangBtn.addEventListener('click', showLanguageSelectionScreen);
        playAgainBtn.addEventListener('click', () => {
            gameOverModal.classList.add('hidden');
            startGame(); 
        });

        async function main() {
            loadingIndicator.classList.remove('hidden');
            appContainer.classList.add('hidden');

            const firebaseReady = await initFirebase();
            if (!firebaseReady && (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined')) {
                console.warn("Firebase not fully initialized due to missing config. Scores will not be saved.");
            }
            
            // Only proceed to show app if firebase is ready (or if it's intentionally disabled but game can run without scores)
            // In this version, if firebaseReady is false due to missing config, the loadingIndicator shows the error and stops.
            if (!firebaseReady) return; // Stop further execution if critical Firebase setup failed

            populateLanguageSelect();
            loadVoices(); 
            if (synth && synth.onvoiceschanged !== undefined && voices.length === 0) {
                synth.onvoiceschanged = loadVoices;
            }
            
            loadingIndicator.classList.add('hidden');
            appContainer.classList.remove('hidden');
            showLanguageSelectionScreen(); 
        }

        main();

    </script>
</body>
</html>
